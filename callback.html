<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Spotify Callback</title>
</head>
<body style="font-family: Arial; margin: 40px;">
    <h1>Spotify Options</h1>
    <div id="status">Loading...</div>

    <div id="actions" style="margin-top:20px; display:none;">
        <button id="createPlaylistBtn" style="padding:10px 18px; font-size:16px; margin-right:15px;">
            Create Playlist from Top 5 Tracks
        </button>

        <button id="showPlaylistsBtn" style="padding:10px 18px; font-size:16px;">
            Show All My Playlists
        </button>
    </div>

    <div id="result" style="margin-top:30px;"></div>

    <script>
        const clientId = "f7e11fa93c254442b9e46b69b406b838";
        const redirectUri = "http://127.0.0.1/fullstack-project/Fullstack-project/callback.html";

        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (!code) {
            document.getElementById("status").innerHTML =
                "<b>Error:</b> No authorization code found!";
        } else {
            exchangeToken(code);
        }

        let accessToken = null;

        async function exchangeToken(code) {
            const codeVerifier = localStorage.getItem("code_verifier");

            const body = new URLSearchParams({
                client_id: clientId,
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier
            });

            const result = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            const data = await result.json();

            if (!data.access_token) {
                document.getElementById("status").innerHTML =
                    "<b>Token Error:</b> " + JSON.stringify(data);
                return;
            }

            accessToken = data.access_token;

            document.getElementById("status").innerHTML = "Logged in successfully!";
            document.getElementById("actions").style.display = "block";
        }

        document.getElementById("createPlaylistBtn").onclick = async () => {
            document.getElementById("result").innerHTML = "Creating playlist...";
            const response = await fetch("createplaylist.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: accessToken })
            });

            const data = await response.json();

            if (data.error) {
                document.getElementById("result").innerHTML = "<b>Error:</b> " + data.error;
                return;
            }

            document.getElementById("result").innerHTML = `
                <h2>Playlist Created ðŸŽ‰</h2>
                <p><b>Name:</b> ${data.playlist.name}</p>
                <p><b>Playlist ID:</b> ${data.playlist.id}</p>
                <P>You can find the playlist on your account, or click right next to here and see it in the list!</P>
            `;
        };

        document.getElementById("showPlaylistsBtn").onclick = async () => {
            document.getElementById("result").innerHTML = "Loading playlists...";
            const response = await fetch("getplaylists.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: accessToken })
            });

            const data = await response.json();

            if (data.error) {
                document.getElementById("result").innerHTML = "<b>Error:</b> " + data.error;
                return;
            }

            let html = "<h2>Your Playlists</h2><ul>";
            data.items.forEach(pl => {
                html += `<li>${pl.name} (${pl.tracks.total} tracks)</li>`;
            });
            html += "</ul>";

            document.getElementById("result").innerHTML = html;
        };
    </script>
</body>
</html>
