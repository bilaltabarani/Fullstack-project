<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Spotify Callback</title>
</head>
<body style="font-family: Arial; margin: 40px;">
    <h1>Creating your playlist...</h1>
    <div id="status">Please wait...</div>

    <script>
        const clientId = "f7e11fa93c254442b9e46b69b406b838";
        const redirectUri = "http://127.0.0.1/fullstack-project/Fullstack-project/callback.html";

        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (!code) {
            document.getElementById("status").innerHTML =
                "<b>Error:</b> No authorization code found!";
        } else {
            exchangeToken(code);
        }

        async function exchangeToken(code) {
            const codeVerifier = localStorage.getItem("code_verifier");

            const body = new URLSearchParams({
                client_id: clientId,
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier
            });

            const result = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            const data = await result.json();

            if (!data.access_token) {
                document.getElementById("status").innerHTML =
                    "<b>Token Error:</b> " + JSON.stringify(data);
                return;
            }

            createPlaylistServerSide(data.access_token);
        }

        async function createPlaylistServerSide(token) {
            const response = await fetch("createplaylist.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token })
            });

            const data = await response.json();

            if (data.error) {
                document.getElementById("status").innerHTML =
                    "<b>Error:</b> " + data.error;
                return;
            }

            document.getElementById("status").innerHTML = `
                <h2>Playlist Created Successfully ðŸŽ‰</h2>
                <p><b>Name:</b> ${data.playlist.name}</p>
                <p><b>Playlist ID:</b> ${data.playlist.id}</p>
                <p>You can find it in your Spotify account.</p>
            `;
        }
    </script>
</body>
</html>
