<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="css/spotifylogin.css">
    <title>Spotify Playlist Generator</title>
</head>

<body style="font-family: Arial; margin: 40px;">
    <nav>
        <h2><a href="home.php">MusicMatch</a></h2>
        <ul>
            <li><a href="home.php">Home</a></li>
            <li><a href="spotifylogin.html">Muziek/Playlists</a></li>
            <a href="logout.php">
                <svg width="12" height="12" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                    <path
                        d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z" />
                </svg>
                Logout
            </a>
        </ul>
    </nav>

    <div style="display: flex;  flex-direction: column;  justify-content: center;   align-items: center;
                height: 50vh;   width: 100vw;   margin-top: 12vh;   padding: 20px;  gap: 50px;">

        <h1 style="text-align: center;">
            Klik op de knop hieronder om een playlist aan te maken of af te spelen, of om gewoon naar 
            muziek te luisteren!
        </h1>
        <button id="loginBtn">
            Login with Spotify
        </button>
    </div>

    <script>
        const clientId = "86759e67500b47eea6022b1f4d9e0c02";
        const redirectUri = "http://127.0.0.1/Fullstack-project/callback.php";

        function generateRandomString(length) {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let result = "";
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function sha256(verifier) {
            const data = new TextEncoder().encode(verifier);
            return await crypto.subtle.digest("SHA-256", data);
        }

        function base64URLEncode(buffer) {
            return btoa(
                Array.from(new Uint8Array(buffer))
                    .map(b => String.fromCharCode(b))
                    .join("")
            )
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=+$/, "");
        }

        document.getElementById("loginBtn").onclick = async () => {
            localStorage.removeItem("code_verifier");

            const codeVerifier = generateRandomString(128);
            localStorage.setItem("code_verifier", codeVerifier);

            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64URLEncode(hashed);

            const scope = "user-top-read playlist-modify-public playlist-modify-private";

            const authUrl =
                "https://accounts.spotify.com/authorize" +
                `?client_id=${clientId}` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&code_challenge_method=S256` +
                `&code_challenge=${codeChallenge}` +
                `&scope=${encodeURIComponent(scope)}`;

            window.location.href = authUrl;
        };
    </script>
</body>

</html>