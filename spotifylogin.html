<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Spotify Playlist Generator</title>
</head>
<body style="font-family: Arial; margin: 40px;">
    <h1>Generate a Playlist from Your Top 5 Songs</h1>
    <button id="loginBtn" style="padding: 12px 20px; font-size: 18px;">
        Login with Spotify
    </button>

    <script>
        const clientId = "f7e11fa93c254442b9e46b69b406b838";
        const redirectUri = "http://127.0.0.1/fullstack-project/Fullstack-project/callback.html";

        function generateRandomString(length) {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let result = "";
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function sha256(verifier) {
            const data = new TextEncoder().encode(verifier);
            return await crypto.subtle.digest("SHA-256", data);
        }

        function base64URLEncode(buffer) {
            return btoa(
                Array.from(new Uint8Array(buffer))
                    .map(b => String.fromCharCode(b))
                    .join("")
            )
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/, "");
        }

        document.getElementById("loginBtn").onclick = async () => {
            localStorage.removeItem("code_verifier");

            const codeVerifier = generateRandomString(128);
            localStorage.setItem("code_verifier", codeVerifier);

            const hashed = await sha256(codeVerifier);
            const codeChallenge = base64URLEncode(hashed);

            const scope = "user-top-read playlist-modify-public playlist-modify-private";

            const authUrl =
                "https://accounts.spotify.com/authorize" +
                `?client_id=${clientId}` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&code_challenge_method=S256` +
                `&code_challenge=${codeChallenge}` +
                `&scope=${encodeURIComponent(scope)}`;

            window.location.href = authUrl;
        };
    </script>
</body>
</html>
